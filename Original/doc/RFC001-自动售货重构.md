# RFC-001：作物售货机多品类并发售卖逻辑重构

# (Optimization of Vending Logic for Multi-Crop Concurrency under Inventory Constraints)

## 1. 背景 (Background)

当前的 `作物自动售货机-v2.js` 脚本采用“单次批量处理”模式。补货逻辑为：从容器中提取 1 个“压缩包”（作物篮子），并在玩家背包中将其解压为 9 组（Stack）原始作物，随后执行出售操作。
已知玩家背包（Backpack）+ 快捷栏（Hotbar）的总容量硬上限为 **36 个槽位**。

**关于拍卖行 (AH) 的特殊约束：**

- **非连续槽位布局**：AH GUI 的有效槽位并非线性排列。
   - **当前可用 (8槽)**：索引 `20, 21, 22, 23, 24` (第一排) 和 `29, 30, 31` (第二排)。
   - **未来扩容 (Max 10槽)**：需预留逻辑支持拓展至 10 个槽位。

## 2. 问题陈述 (Problem Statement)

当前逻辑存在**库存资源溢出（Inventory Overflow）**风险，且缺乏对游戏经济周期（每日特供）的响应机制。

### 2.1 空间溢出风险

$$
Space_{required} = N_{types} \times 9 \text{ (slots)}
$$

当 $N \ge 5$ 时，需求槽位 > 36，导致系统卡死。

### 2.2 业务逻辑缺陷 (Business Logic Gaps)

- **盲目补货**：之前的逻辑尝试轮询售卖所有作物，但这与游戏机制不符。
- **Jacko 机制误判**：Jacko 每天**随机收购 1 种**作物，且**限量 3 组**。盲目拿取非当日收购的作物纯属浪费。
- **市场关联性**：Jacko 收购的作物通常意味着当日玩家需求高，必须同步在拍卖行（AH）上架。
- **AH 布局适配缺失**：AH 槽位索引离散（20-24, 29-31），简单遍历 0-9 会导致操作错误（例如误触背景板或其他按钮）。

## 3. 需求目标 (Objectives)

1. **每日热销聚焦**：识别今日 Jacko 收购作物，**仅处理这一种**。
2. **双渠道销售**：
   - **Jacko**：吃满 3 组限额。
   - **AH**：至少上架 3 组。

3. **AH 智能维护**：
   - 支持**非连续槽位检测**（Whitelist Mapping）。
   - 如果可用槽位不足以支撑“3组上架”，自动清理旧货。
   - 支持未来扩容至 10 槽。

4. **零残留**：每日任务完成后，剩余作物存回箱子。
5. **动态补货**：监听市场售出消息，自动补货。

## 4. 技术方案演进 (Evolution of Technical Solutions)

### 方案 D：每日热销单品策略 (Daily Hot-Item Strategy - 最终推荐)

**核心哲学：** 每天只做一件事——卖“今日特供”。

**详细业务流程：**

1. **阶段 0: 每日情报获取 (Daily Recon)**
   - **动作**：前往 Jacko 处打开 GUI。
   - **解析**：识别今日收购的唯一作物（例如 "Pumpkin"）。
   - *决策*：如果仓库里没有 "Pumpkin"，则休眠或报错；如果有，进入下一阶段。

2. **阶段 1: 市场空间准备 (Market Prep)**
   - **配置读取**：加载 AH 槽位配置 `AH_VALID_SLOTS = [20, 21, 22, 23, 24, 29, 30, 31]`。
   - **状态扫描**：遍历上述 Index，检查 `Inventory.getSlot(i)` 是否为空。
   - **计算**：`NeedSlots = 3` (保底上架量)。
   - **腾挪**：如果 `FreeSlots < NeedSlots`，则在 `AH_VALID_SLOTS` 中寻找非今日特供的物品，执行 `quick()` 回收，直到空间足够。

3. **阶段 2: 仓库作业 (Warehouse Ops)**
   - **精准清理 (Selective Purge)**：遍历背包，**仅**将“非今日特供的其他作物”存回箱子。
   - **取货**：从箱子取 **1 个** 今日特供作物的篮子（1 篮子 = 9 组）。
   - **解压**：`Inventory.unpack()`。

4. **阶段 3: 销售执行 (Sales Execution)**
   - **Step 3.1: 喂饱 Jacko**
      - 与 Jacko 交互，出售作物直到提示“限额已满”或卖出 3 组。

   - **Step 3.2: 铺货 AH**
      - 拿着作物，执行 `/auction {price}`。
      - 循环执行 3 次（或直到达到 AH 上架保底目标）。

5. **阶段 4: 收尾与监听 (Cleanup & Listen)**
   - **回存 (Deposit)**：将背包内剩余作物存回箱子。
   - **监听模式 (Listening Mode)**：
      - Hook 聊天栏消息。
      - **触发条件**：正则匹配消息 `Player (.*) bought your (.*) for (.*)`。
         举例: Johnx117 bought your 64x ꢲ Apple for 825 rubies!
      - **响应动作**：触发补货流程。

## 5. 验收标准 (Acceptance Criteria)

1. **槽位索引正确性**：脚本只能操作 `[20-24, 29-31]` 范围内的槽位，严禁操作其他槽位（避免误取不可取出的展示物品）。
2. **扩容兼容性**：验证通过修改配置数组即可支持 10 个槽位，无需重写核心逻辑。
3. **精准清理**：在 AH 满载时，优先下架旧物品，保留今日热销品。